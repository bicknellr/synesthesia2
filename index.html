<html>
<head>

<script>

var WaveDrawer = (function () {
  function WaveDrawer (params) {
    this.canvas = params.canvas;
    this.context = this.canvas.getContext("2d");

    this.channels = [];

    this.colors = [
      "rgba(255, 0, 0, 255)",
      "rgba(0, 255, 0, 255)",
      "rgba(0, 0, 255, 255)",
      "rgba(255, 0, 255, 255)",
    ];
  }

  WaveDrawer.prototype.pushSamples = function (channel, new_samples) {
    if (!this.channels[channel]) {
      this.channels[channel] = [];
    }

    var cur_channel = this.channels[channel];

    // Add new channel data.
    cur_channel = cur_channel.concat(new_samples);

    // Remove non-visible samples.
    cur_channel = cur_channel.slice(
      cur_channel.length - (+this.canvas.width),
      cur_channel.length + 1
    );

    // Draw.
    var ctx = this.context;
    ctx.globalCompositeOperation = "lighter";
    ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

    ctx.beginPath();
    for (var i = cur_channel.length - 1; i >= 0; i--) {
      var y_pos = (this.canvas.height / 2) * -cur_channel[i] + this.canvas.height / 2;
      if (i == cur_channel.length - 1) {
        ctx.moveTo(i, y_pos);
      } else {
        ctx.lineTo(i, y_pos);
      }
    }
    ctx.strokeStyle = this.colors[channel % this.colors.length];
    ctx.stroke();
  };

  return WaveDrawer;
})();

</script>

<script src="./module.js"></script>
<script src="./Graph.js"></script>
<script src="./Synesthesia.js"></script>
<script src="./MainOutput.js"></script>
<script src="./Gain.js"></script>
<script src="./Oscillator.js"></script>
<script src="./BitCrusher.js"></script>
<script src="./MIDISource.js"></script>
<script src="./MIDIPitch.js"></script>
<script src="./ScriptProcessor.js"></script>

<script>

module.declare("MAIN", [
  "Synesthesia",
  "MainOutput",
  "Oscillator",
  "Gain",
  "ScriptProcessor",
  "BitCrusher",
  "MIDIPitch",
], function () {

  var Synesthesia = module.require("Synesthesia");

  window.addEventListener("load", function () {

    main_wave_drawer = new WaveDrawer({
      canvas: document.getElementById("wave_canvas")
    });

    MainSynesthesia = new Synesthesia();

    main_output = MainSynesthesia.produceNode("MainOutput");

    // wave processor
    wave_processor = MainSynesthesia.produceNode("ScriptProcessor", {
      bufferSize: 2048, inputChannelCount: 2, outputChannelCount: 2,
      callback: function (data) {
        for (var channel_ix = 0; channel_ix < data.outputBuffer.numberOfChannels; channel_ix++) {
          data.outputBuffer.getChannelData(channel_ix).set(data.inputBuffer.getChannelData(channel_ix));

          main_wave_drawer.pushSamples(
            channel_ix,
            Array.prototype.slice.apply(data.inputBuffer.getChannelData(channel_ix))
          );
        }
      }
    });
    wave_processor.getOutput("audio").connectTo(main_output.getInput("audio"));

    bitcrusher1 = MainSynesthesia.produceNode("BitCrusher");
    bitcrusher1.getOutput("audio").connectTo(wave_processor.getInput("audio"));

    osc1 = MainSynesthesia.produceNode("Oscillator");
    osc1.api_node.frequency.setValueAtTime(0, 0);
    osc1.getOutput("audio").connectTo(bitcrusher1.getInput("audio"));

    freq_auto = new Synesthesia.DataTypes.Automation();
    for (var i = 0; i < 25; i++) {
      freq_auto.addKeyframe(
        new Synesthesia.DataTypes.Automation.Keyframe({
          time: i * 0.1, value: 110 * Math.pow(2, i/12), curve: Synesthesia.DataTypes.Automation.Keyframe.Curves.Set
        })
      );
    }
    freq_auto.addKeyframe(
      new Synesthesia.DataTypes.Automation.Keyframe({
        time: 3.0, value: 0, curve: Synesthesia.DataTypes.Automation.Keyframe.Curves.Set
      })
    );
    osc1.getInput("frequency").setAutomation(freq_auto);

    bit_auto = new Synesthesia.DataTypes.Automation();
    bit_auto.addKeyframe(
      new Synesthesia.DataTypes.Automation.Keyframe({
        time: 0, value: 16, curve: Synesthesia.DataTypes.Automation.Keyframe.Curves.Set
      })
    );
    bit_auto.addKeyframe(
      new Synesthesia.DataTypes.Automation.Keyframe({
        time: 1.2, value: 0.1, curve: Synesthesia.DataTypes.Automation.Keyframe.Curves.Linear
      })
    );
    bit_auto.addKeyframe(
      new Synesthesia.DataTypes.Automation.Keyframe({
        time: 2.4, value: 16, curve: Synesthesia.DataTypes.Automation.Keyframe.Curves.Exponential
      })
    );
    bitcrusher1.getInput("width").setAutomation(bit_auto);

    midi0 = MainSynesthesia.produceNode("MIDISource");

    // Test functions.

    START = function () {
      bitcrusher1.getInput("width").setTime(0);
      osc1.api_node.start(0);
    };

    STOP = function () {
      osc1.api_node.stop(0);
    };
  });

});

START = function () {};
STOP = function () {};

</script>
<head>
<body>

<button onclick="START()">START</button>
<button onclick="STOP()">STOP</button>
<br />
<canvas id="wave_canvas" style="background-color:black;" width="640" height="240"></canvas>

</body>
<html>
